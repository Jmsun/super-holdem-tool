<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>德扑买入结算 · ES5 核心版（稳定）</title>
<body style="font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0b0f14; color:#e6edf3; margin:0">
  <header style="position:sticky;top:0;background:#0f1620;border-bottom:1px solid #1b2430">
    <div style="max-width:980px;margin:0 auto;padding:12px;display:flex;align-items:center;gap:8px">
      <h3 style="margin:0;font-size:18px">德州扑克买入与结算（ES5 核心版）</h3>
      <span id="balanceTip" style="margin-left:auto;border:1px solid #2b3b4f;border-radius:999px;padding:2px 8px;color:#bcd0e4">试算平衡：0</span>
    </div>
  </header>

  <main style="max-width:980px;margin:0 auto;padding:12px;display:grid;gap:12px">
    <section style="background:#121821;border:1px solid #1b2430;border-radius:12px;padding:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end">
        <div style="flex:1 1 280px;min-width:260px">
          <div style="font-size:12px;color:#a9b6c6">添加玩家昵称</div>
          <input id="playerName" placeholder="输入昵称，例如：张三" style="width:100%;padding:10px;border-radius:10px;border:1px solid #243142;background:#0f141c;color:#e6edf3"/>
        </div>
        <div>
          <div style="font-size:12px;color:#a9b6c6">观星费（默认20）</div>
          <input id="defaultStar" type="number" value="20" style="width:120px;padding:10px;border-radius:10px;border:1px solid #243142;background:#0f141c;color:#e6edf3" onchange="render()"/>
        </div>
        <div>
          <div style="font-size:12px;color:#a9b6c6">会员费（默认20）</div>
          <input id="defaultMember" type="number" value="20" style="width:120px;padding:10px;border-radius:10px;border:1px solid #243142;background:#0f141c;color:#e6edf3" onchange="render()"/>
        </div>
        <div>
          <div style="font-size:12px;color:#a9b6c6">结算方式</div>
          <select id="settleMode" style="padding:10px;border-radius:10px;border:1px solid #243142;background:#0f141c;color:#e6edf3" onchange="setMode(this.value)">
            <option value="none">不打折</option>
            <option value="half">除2</option>
            <option value="third">除3</option>
          </select>
        </div>
        <button id="addPlayerBtn" type="button" onclick="onAddPlayer()" style="padding:10px 14px;border-radius:12px;background:#1b2734;border:1px solid #2b3b4f;color:#e6edf3">＋ 添加玩家</button>
        <button type="button" onclick="toggleRoster()" style="padding:10px 14px;border-radius:12px;background:#1b2734;border:1px solid #2b3b4f;color:#e6edf3">从微信群接龙粘贴解析</button>
      </div>
      <div id="pasteBox" style="display:none;margin-top:10px">
        <textarea id="rosterText" rows="4" placeholder="粘贴微信群接龙，如：
1. 张三
2）李四
3、王五（备注）" style="width:100%;padding:10px;border-radius:10px;border:1px solid #243142;background:#0f141c;color:#e6edf3"></textarea>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button type="button" onclick="parseRoster()" style="padding:10px 14px;border-radius:12px;background:#1f5730;border:1px solid #1e7a3a;color:#e6edf3">解析并添加</button>
          <span style="font-size:12px;color:#a9b6c6">支持格式：1. 张三 / 2）李四 / 3、王五</span>
        </div>
      </div>
    </section>

    <section style="background:#121821;border:1px solid #1b2430;border-radius:12px;padding:12px;max-height:60vh;overflow:auto">
      <table style="width:100%;border-collapse:separate;border-spacing:0">
        <thead>
          <tr style="color:#a9b6c6;position:sticky;top:0;background:#121821">
            <th style="padding:8px">#</th>
            <th>昵称</th>
            <th>买入</th>
            <th>快捷</th>
            <th>兑现</th>
            <th>观星</th>
            <th>会员</th>
            <th>结算</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section style="background:#121821;border:1px solid #1b2430;border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-size:12px">（先点某位玩家“买入”，再按快捷）</span>
      </div>
      <div style="display:flex;gap:12px;font-size:14px;color:#a9b6c6">
        <span>总买入：<b id="sumIn" style="font-family:ui-monospace">0</b></span>
        <span>总兑现：<b id="sumOut" style="font-family:ui-monospace">0</b></span>
        <span>差额：<b id="diff" style="font-family:ui-monospace">0</b></span>
      </div>
    </section>
  </main>

<script>
// ====== ES5 纯语法实现 ======
var storeKey='poker-core-es5-1';
var state={ players:[], mode:'none' };
var activeBuyInputId=null;

function $(sel){ return document.querySelector(sel); }
function save(){ try{ localStorage.setItem(storeKey, JSON.stringify(state)); }catch(e){} }
function load(){ try{ var x=JSON.parse(localStorage.getItem(storeKey)); if(x){ state=x; } }catch(e){}; var m=$('#settleMode'); if(m){ m.value=state.mode; } render(); }

function currentStar(){ var el=$('#defaultStar'); var v=el&&el.value?el.value:0; return +v||0; }
function currentMember(){ var el=$('#defaultMember'); var v=el&&el.value?el.value:0; return +v||0; }

function onAddPlayer(){ var v=$('#playerName').value; addPlayer(v); $('#playerName').value=''; }
function addPlayer(name){ name=(name||'').replace(/^\\s+|\\s+$/g,''); if(!name) return; for(var i=0;i<state.players.length;i++){ if(state.players[i].name===name) return; } var id='id-'+Math.random().toString(36).slice(2)+(+new Date()); state.players.push({id:id,name:name,buyin:0,cashout:0,starFlag:false,memberFlag:false}); save(); render(); }
function toggleRoster(){ var b=document.getElementById('pasteBox'); b.style.display=(b.style.display==='none'||!b.style.display)?'block':'none'; }
function parseRoster(){ var t=document.getElementById('rosterText'); var txt=(t&&t.value)||''; var lines=txt.split(/\\r?\\n/); var i,ln,names=[]; for(i=0;i<lines.length;i++){ ln=(lines[i]||'').replace(/^\\s+|\\s+$/g,''); if(!ln) continue; var s=ln; while(s && ' 0123456789.、,，)）]】:：-'.indexOf(s.charAt(0))!==-1){ s=s.slice(1); } var i1=s.indexOf('('), i2=s.indexOf('（'); var cut=[]; if(i1>=0) cut.push(i1); if(i2>=0) cut.push(i2); if(cut.length){ s=s.slice(0, Math.min.apply(null, cut)); } s=s.replace(/^\\s+|\\s+$/g,''); if(s) names.push(s); } if(!names.length){ alert('未识别到昵称'); return; } for(i=0;i<names.length;i++){ addPlayer(names[i]); } if(t) t.value=''; toggleRoster(); }

function setMode(m){ state.mode=m; save(); render(); }
function byId(id){ for(var i=0;i<state.players.length;i++){ if(state.players[i].id===id) return state.players[i]; } return null; }
function calcSettle(p){ var buy=+p.buyin||0, cash=+p.cashout||0; var star=p.starFlag?currentStar():0; var mem=p.memberFlag?currentMember():0; var base=cash-buy+star; if(state.mode==='half') base/=2; else if(state.mode==='third') base/=3; return +(base+mem).toFixed(2); }
function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, function(c){ return {\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[c]; }); }

function render(){
  var tb=document.getElementById('tbody'); tb.innerHTML='';
  for(var i=0;i<state.players.length;i++){
    var p=state.players[i]; var tr=document.createElement('tr');
    tr.innerHTML=''
      + '<td style=\"padding:8px;font-family:ui-monospace\">'+(i+1)+'</td>'
      + '<td>'+escapeHtml(p.name)+'</td>'
      + '<td><input type=\"number\" value=\"'+p.buyin+'\" style=\"width:100px\" onfocus=\"activeBuyInputId=\\''+p.id+'\\'\" onchange=\"updateBuy(\\''+p.id+'\\', this.value)\"/></td>'
      + '<td>'
      + '  <button type=\"button\" onclick=\"quick(\\''+p.id+'\\',50)\" style=\"padding:6px 10px\">＋50</button>'
      + '  <button type=\"button\" onclick=\"quick(\\''+p.id+'\\',100)\" style=\"padding:6px 10px\">＋100</button>'
      + '  <select onchange=\"quick(\\''+p.id+'\\', this.value); this.value=\\'\\'\" style=\"padding:6px 8px\">'
      + '    <option value=\"\">更多</option>'
      + '    <option value=\"200\">＋200</option>'
      + '    <option value=\"300\">＋300</option>'
      + '  </select>'
      + '</td>'
      + '<td><input type=\"number\" value=\"'+p.cashout+'\" style=\"width:100px\" onchange=\"updateCash(\\''+p.id+'\\', this.value)\"/></td>'
      + '<td style=\"text-align:center\"><input type=\"checkbox\" '+(p.starFlag?'checked':'')+' onchange=\"toggleStar(\\''+p.id+'\\', this.checked)\"/> <span style=\"font-size:12px;color:#a9b6c6\">'+currentStar().toFixed(0)+'</span></td>'
      + '<td style=\"text-align:center\"><input type=\"checkbox\" '+(p.memberFlag?'checked':'')+' onchange=\"toggleMember(\\''+p.id+'\\', this.checked)\"/> <span style=\"font-size:12px;color:#a9b6c6\">'+currentMember().toFixed(0)+'</span></td>'
      + '<td style=\"font-family:ui-monospace\">'+calcSettle(p).toFixed(2)+'</td>'
      + '<td><button type=\"button\" onclick=\"delPlayer(\\''+p.id+'\\')\">删除</button></td>';
    tb.appendChild(tr);
  }
  updateTotals(); save();
}

function updateTotals(){
  var totalIn=0,totalOut=0,i;
  for(i=0;i<state.players.length;i++){ totalIn+=+state.players[i].buyin||0; totalOut+=+state.players[i].cashout||0; }
  var diff=totalOut-totalIn;
  document.getElementById('sumIn').textContent=totalIn.toFixed(2);
  document.getElementById('sumOut').textContent=totalOut.toFixed(2);
  document.getElementById('diff').textContent=diff.toFixed(2);
  document.getElementById('balanceTip').textContent = diff===0? '试算平衡：0' : (diff>0? ('试算超额兑付：'+diff.toFixed(2)) : ('试算超额买入：'+(-diff).toFixed(2)));
}

function updateBuy(id,v){ var p=byId(id); if(!p) return; p.buyin=+v||0; render(); }
function updateCash(id,v){ var p=byId(id); if(!p) return; p.cashout=+v||0; render(); }
function quick(id,v){ v=+v||0; var p=byId(id); if(!p) return; p.buyin=(+p.buyin||0)+v; render(); }
function toggleStar(id,flag){ var p=byId(id); if(!p) return; p.starFlag=!!flag; render(); }
function toggleMember(id,flag){ var p=byId(id); if(!p) return; p.memberFlag=!!flag; render(); }
function delPlayer(id){ var p=byId(id); if(!p) return; if((+p.buyin||0)>0){ alert('该玩家已有买入记录，不能删除'); return; } var arr=[],i; for(i=0;i<state.players.length;i++){ if(state.players[i].id!==id) arr.push(state.players[i]); } state.players=arr; render(); }

// 启动
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', function(){ var input=document.getElementById('playerName'); if(input){ input.onkeydown=function(e){ e=e||window.event; var k=e.key||e.keyCode; if(k==='Enter'||k===13){ onAddPlayer(); } }; } load(); });
}else{
  var input=document.getElementById('playerName'); if(input){ input.onkeydown=function(e){ e=e||window.event; var k=e.key||e.keyCode; if(k==='Enter'||k===13){ onAddPlayer(); } }; } load();
}
</script>
</body>
</html>
