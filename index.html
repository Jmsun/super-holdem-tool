<!doctype html>
<html>
<meta charset="utf-8">
<title>Speak</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#fafafa;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:680px;padding:24px;text-align:center}
  button{font-size:18px;padding:12px 18px;border-radius:12px;border:0;box-shadow:0 6px 18px rgba(0,0,0,.08);cursor:pointer}
  .muted{color:#b00;margin-top:10px;font-size:14px}
  .txt{margin:12px 0 18px;color:#333;word-break:break-word}
</style>
<body>
<div class="wrap">
  <div id="msg" class="txt"></div>
  <button id="play">ğŸ”Š æ’­æ”¾/é‡æ’­</button>
  <div id="hint" class="muted"></div>
</div>
<script>
(function(){
  const sp = new URL(location.href).searchParams;
  const text = sp.get("t") || "";
  const lang = sp.get("lang") || "zh-CN";
  const rate = Math.max(.5, Math.min(2, parseFloat(sp.get("rate")||"1.05")));
  const pitch= Math.max(0, Math.min(2, parseFloat(sp.get("pitch")||"1")));
  const autoplay = sp.get("autoplay")==="1";   // å¯é€‰ï¼š?autoplay=1
  const $msg = document.getElementById("msg");
  const $hint= document.getElementById("hint");
  const $btn = document.getElementById("play");
  $msg.textContent = text ? `å°†æ’­æŠ¥ï¼š${text}` : "æœªæä¾›æ’­æŠ¥æ–‡æœ¬ï¼ˆt å‚æ•°ä¸ºç©ºï¼‰";

  let voices = [];
  function pickVoice() {
    // ä¼˜å…ˆä¸­æ–‡ï¼Œå…¶æ¬¡ç³»ç»Ÿé»˜è®¤
    const zh = voices.find(v => /zh|cmn/i.test(v.lang));
    return zh || speechSynthesis.getVoices()[0] || null;
  }

  function speak() {
    if (!text) { $hint.textContent = "t å‚æ•°ä¸ºç©ºï¼Œæ— æ³•æ’­æŠ¥"; return; }
    try {
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if (v) u.voice = v;
      u.lang = v?.lang || lang;
      u.rate = rate;
      u.pitch = pitch;
      speechSynthesis.speak(u);
      $hint.textContent = "";
    } catch(e) {
      $hint.textContent = "å½“å‰ç¯å¢ƒä¸æ”¯æŒè¯­éŸ³æ’­æŠ¥ï¼ˆå¯èƒ½æ˜¯Appå†…WebViewæˆ–æƒé™é™åˆ¶ï¼‰ã€‚";
    }
  }

  // iOS éœ€è¦â€œç”¨æˆ·æ‰‹åŠ¿â€è§¦å‘ï¼›æŒ‰é’®å°±æ˜¯æ‰‹åŠ¿è§¦å‘å™¨
  $btn.addEventListener("click", speak);

  // ç­‰å¾… voices åŠ è½½ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
  function initWhenReady() {
    voices = speechSynthesis.getVoices();
    if (!voices || voices.length === 0) {
      // å†ç­‰ç­‰
      setTimeout(initWhenReady, 150);
      return;
    }
    if (autoplay) {
      // å°è¯•è‡ªåŠ¨æ’­ï¼Œè‹¥è¢«ç­–ç•¥æ‹¦æˆªï¼Œç”¨æˆ·å¯ç‚¹æŒ‰é’®
      try { speak(); } catch(e) {}
    } else {
      $hint.textContent = "å¦‚æ— å£°ï¼Œè¯·ç¡®è®¤æœªé™éŸ³ï¼Œå¹¶ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ’­æ”¾ã€‚";
    }
  }

  // iOS 15+ æœ‰æ—¶ voiceschanged ä¸è§¦å‘ï¼ŒåŒä¿é™©
  if ('onvoiceschanged' in speechSynthesis) {
    speechSynthesis.onvoiceschanged = () => {
      voices = speechSynthesis.getVoices();
    };
  }
  // é¡µé¢å¯è§æ—¶å†åˆå§‹åŒ–ï¼Œé¿å…åå°æ€åŠ è½½å¤±è´¥
  if (document.visibilityState === "visible") initWhenReady();
  else document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") initWhenReady();
  });

  // é¢å¤–å…œåº•ï¼šä»»æ„è§¦æ‘¸ä¹Ÿè§†ä¸ºâ€œæ‰‹åŠ¿â€
  document.body.addEventListener("touchstart", function once(){
    document.body.removeEventListener("touchstart", once, {passive:true});
    if (!autoplay) return;
    // å†è¯•ä¸€æ¬¡
    try { speak(); } catch(e) {}
  }, {passive:true});

})();
</script>
</body>
</html>
