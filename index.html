<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>德州扑克买入结算工具</title>
    <!-- React / ReactDOM 来自 unpkg CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel 用于浏览器端编译 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-[#f5f7fb]">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useRef } = React;

      const initialNames = [
        "Jim", "li yuelin", "Jack", "Ying qi", "Annmary", "Bo", "Sue", "he", "Emma", "Sun", "Alex", "Tony", "ke", "Dudu", "Jasonma",
      ];
      const DiscountOptions = [
        { key: "none", label: "不打折", factor: 1 },
        { key: "half", label: "除2", factor: 0.5 },
        { key: "third", label: "除3", factor: 1/3 },
      ];
      const round5up = (v) => Math.ceil(v/5)*5;
      const currency = (n) => (Math.round((Number(n)||0)*100)/100).toFixed(2);
      const clampMinZero = (n) => Math.max(0, Number(n)||0);
      const tierTaxByWin = (win) => {
        const w = Number(win)||0;
        if(w<50) return 0;
        if(w<75) return 5;
        const blocks = Math.floor((w-75)/50);
        return 10 + 5*blocks;
      };

      function computeAll(players, globalDiscountKey, starFee, memberFee, acceptedDiffRaw, preFeaturePayoutRaw){
        const factor = (DiscountOptions.find(d=>d.key===globalDiscountKey)||{factor:1}).factor;
        const totalBuyRaw = players.reduce((a,p)=>a+(p.buys||[]).reduce((x,y)=>x+y,0),0);
        const totalPayoutRaw = players.reduce((a,p)=>a+(p.includePayout?(Number(p.payoutStr)||0):0),0);
        const trialBalanceExtraRaw = Number(preFeaturePayoutRaw)||0;
        const trialBalanceRaw = totalBuyRaw-totalPayoutRaw-trialBalanceExtraRaw;
        const trialBalanceVisible = trialBalanceRaw-(acceptedDiffRaw||0);
        let totalDeltaDiscounted=0,totalDeltaRounded=0,totalRoundingOverflow=0,totalTaxPlayers=0;

        const rows = players.map(p=>{
          const rawBuy = (p.buys||[]).reduce((s,v)=>s+v,0);
          const star = p.stargazer?Number(starFee)||0:0;
          const payout = p.includePayout?(Number(p.payoutStr)||0):0;
          const discountedDelta = (payout-rawBuy-star)*factor;
          const lossForRelief = Math.max(0,-discountedDelta);
          const roundedDelta = round5up(discountedDelta);
          const roundingOverflow = roundedDelta-discountedDelta;
          const memberBase = (Number(p.memberCount||0)||0)*(Number(memberFee)||0);
          let memberAfterRelief = memberBase;
          if((p.memberCount||0)>=2){
            if(lossForRelief>=300) memberAfterRelief=memberBase*0.5;
            else if(lossForRelief>=200) memberAfterRelief=clampMinZero(memberBase-10);
          }
          const net = roundedDelta-memberAfterRelief;
          let tax = tierTaxByWin(net);
          if((p.memberCount||0)>=2){
            if(tax>=40) tax=clampMinZero(tax-20);
            else if(tax>=20) tax=clampMinZero(tax-10);
          }
          totalDeltaDiscounted+=discountedDelta;
          totalDeltaRounded+=roundedDelta;
          totalRoundingOverflow+=roundingOverflow;
          if(tax>0) totalTaxPlayers+=tax;
          return {...p, rawBuy, star, discountedDelta, roundedDelta, roundingOverflow, memberBase, memberAfterRelief, lossForRelief, net, tax};
        });

        return {factor, rows, totalBuyRaw, totalPayoutRaw, trialBalanceRaw, trialBalanceVisible, totalDeltaDiscounted, totalDeltaRounded, totalRoundingOverflow, totalTaxPlayers, trialBalanceExtraRaw};
      }

      function App(){
        const [speakOn,setSpeakOn]=useState(true);
        const [speakRate,setSpeakRate]=useState(1.0);
        const speakLock=useRef(false);
        function speak(text){ try{ if(!speakOn||!window.speechSynthesis) return; if(speakLock.current) return; speakLock.current=true; const u=new SpeechSynthesisUtterance(text); u.rate=speakRate; u.lang="zh-CN"; u.onend=()=>{speakLock.current=false;}; speechSynthesis.speak(u);}catch{}}

        const [globalDiscountKey,setGlobalDiscountKey]=useState("none");
        const [starFee,setStarFee]=useState(20);
        const [memberFee,setMemberFee]=useState(20);
        const [starFeeDraft,setStarFeeDraft]=useState("20");
        const [memberFeeDraft,setMemberFeeDraft]=useState("20");
        const [payoutDraft,setPayoutDraft]=useState({});
        const [newPlayerNameDraft,setNewPlayerNameDraft]=useState("");
        const [acceptedDiffRaw,setAcceptedDiffRaw]=useState(0);
        const [acceptedTaxFromDiff,setAcceptedTaxFromDiff]=useState(0);
        const [preFeaturePayoutRaw,setPreFeaturePayoutRaw]=useState(0);
        const [players,setPlayers]=useState(initialNames.map((name,idx)=>({id:String(idx+1),name,buys:[],payoutStr:"",includePayout:false,stargazer:false,memberCount:0})));

        const computed = useMemo(()=>computeAll(players,globalDiscountKey,starFee,memberFee,acceptedDiffRaw,preFeaturePayoutRaw),[players,globalDiscountKey,starFee,memberFee,acceptedDiffRaw,preFeaturePayoutRaw]);

        function addPlayer(){
          const name=newPlayerNameDraft.trim(); if(!name) return;
          setPlayers(prev=>[...prev,{id:String(Date.now()),name,buys:[],payoutStr:"",includePayout:false,stargazer:false,memberCount:0}]);
          setNewPlayerNameDraft("");
        }
        function removePlayer(id){ setPlayers(prev=>prev.filter(p=>p.id!==id)); }
        function updatePlayer(id,updater){ setPlayers(prev=>prev.map(p=>p.id===id?updater(p):p)); }
        function acceptCurrentDifference(){
          const diffRaw=computed.trialBalanceRaw-acceptedDiffRaw;
          if(Math.abs(diffRaw)<1e-9) return;
          const intoTax=diffRaw*(computed.factor||1);
          setAcceptedDiffRaw(v=>v+diffRaw);
          setAcceptedTaxFromDiff(v=>v+intoTax);
          alert(`已接受差额：原始 ¥${currency(diffRaw)}，折后入税池 ¥${currency(intoTax)}`);
        }
        const Card=({children})=>(<div className="bg-white rounded-2xl shadow p-4">{children}</div>);

        return (<div className="min-h-screen p-4 space-y-6 bg-[#f5f7fb]">
          <h1 className="text-2xl font-bold">德州扑克买入结算工具</h1>
          {/* 顶部设置 */}
          <Card>
            <div className="grid gap-4 md:grid-cols-5">
              <label className="flex items-center gap-2"><span className="text-sm">全局打折</span>
                <select className="rounded-lg border px-3 py-2 bg-sky-50" value={globalDiscountKey} onChange={e=>setGlobalDiscountKey(e.target.value)}>
                  {DiscountOptions.map(d=><option key={d.key} value={d.key}>{d.label}</option>)}
                </select>
              </label>
              <label className="flex items-center gap-2"><span className="text-sm">观星费用</span>
                <input type="text" className="rounded-lg border px-3 py-2 bg-emerald-50" value={starFeeDraft} onChange={e=>setStarFeeDraft(e.target.value)} onBlur={()=>setStarFee(Number(starFeeDraft)||0)} />
              </label>
              <label className="flex items-center gap-2"><span className="text-sm">会员单次</span>
                <input type="text" className="rounded-lg border px-3 py-2 bg-purple-50" value={memberFeeDraft} onChange={e=>setMemberFeeDraft(e.target.value)} onBlur={()=>setMemberFee(Number(memberFeeDraft)||0)} />
              </label>
              <div className="flex items-center gap-2 md:col-span-2">
                <input placeholder="新玩家名字" className="rounded-lg border px-3 py-2 flex-1 bg-indigo-50" value={newPlayerNameDraft} onChange={e=>setNewPlayerNameDraft(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addPlayer()} />
                <button className="rounded-2xl px-4 py-2 text-white bg-indigo-600" onClick={addPlayer}>添加</button>
              </div>
            </div>
          </Card>
          {/* 玩家表格 */}
          <Card>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-gray-600"><th className="px-3 py-2">玩家</th><th className="px-3 py-2">买入</th><th className="px-3 py-2">兑付</th><th className="px-3 py-2">观星</th><th className="px-3 py-2">会员</th><th className="px-3 py-2">净额/折后/税</th><th className="px-3 py-2">操作</th></tr></thead>
                <tbody>
                  {players.map(p=>{
                    const row=(computed.rows.find(r=>r.id===p.id))||{rawBuy:0,star:0,discountedDelta:0,roundedDelta:0,roundingOverflow:0,memberAfterRelief:0,net:0,tax:0};
                    const canDelete=(p.buys||[]).length===0;
                    return (<tr key={p.id} className="border-t">
                      <td className="px-3 py-3">{p.name}<div className="text-xs text-gray-500">{p.buys.length?`买入：${p.buys.join(",")}`:"无"}</div></td>
                      <td className="px-3 py-3"><button onClick={()=>updatePlayer(p.id,pp=>({...pp,buys:[...pp.buys,100]}))} className="px-3 py-2 bg-cyan-600 text-white rounded">+100</button></td>
                      <td className="px-3 py-3"><input className="border px-2" type="text" value={payoutDraft[p.id]??p.payoutStr} onChange={e=>{const v=e.target.value;setPayoutDraft(d=>({...d,[p.id]:v}));updatePlayer(p.id,pp=>({...pp,payoutStr:v}));}} /> <input type="checkbox" checked={p.includePayout} onChange={e=>updatePlayer(p.id,pp=>({...pp,includePayout:e.target.checked}))} />计入</td>
                      <td className="px-3 py-3"><input type="checkbox" checked={p.stargazer} onChange={e=>updatePlayer(p.id,pp=>({...pp,stargazer:e.target.checked}))}/> {p.stargazer?`¥${currency(starFee)}`:"未选"}</td>
                      <td className="px-3 py-3"><button onClick={()=>updatePlayer(p.id,pp=>({...pp,memberCount:pp.memberCount+1}))} className="px-3 py-2 bg-purple-600 text-white rounded">+会员</button> 次数：{p.memberCount}</td>
                      <td className="px-3 py-3">净额：{row.net} 折后：{row.roundedDelta} 税：{row.tax}</td>
                      <td className="px-3 py-3"><button disabled={!canDelete} onClick={()=>removePlayer(p.id)} className="px-3 py-2 bg-rose-600 text-white rounded">删除</button></td>
                    </tr>)} )}
                </tbody>
              </table>
            </div>
          </Card>
          {/* 底部 */}
          <Card><div>折前总买入：{currency(computed.totalBuyRaw)} 折前总兑付：{currency(computed.totalPayoutRaw)}</div></Card>
        </div>);
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
